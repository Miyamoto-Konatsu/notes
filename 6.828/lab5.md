## 文件系统

本实验室的目标不是让您实现整个文件系统，而是让您只实现某些关键组件。特别是，您将负责将块读入块缓存并将其刷新回磁盘；分配磁盘块；将文件偏移量映射到磁盘块；在IPC接口中实现读、写、打开。由于您不用自己实现所有文件系统，因此熟悉提供的代码和各种文件系统接口非常重要。

## 磁盘访问

我们操作系统中的文件系统环境需要能够访问磁盘，但我们尚未在内核中实现任何磁盘访问功能。我们没有采用传统的“单片”操作系统策略，即向内核添加IDE磁盘驱动程序以及必要的系统调用以允许文件系统访问它，而是将IDE磁盘驱动程序作为用户级文件系统环境的一部分来实现。我们仍然需要稍微修改内核，以便进行设置，使文件系统环境具有实现磁盘访问本身所需的权限。

只要我们依靠轮询、“基于编程I/O”（PIO）的磁盘访问，并且不使用磁盘中断，就可以很容易地在用户空间中实现磁盘访问。在用户模式下也可以实现中断驱动的设备驱动程序（例如，L3和L4内核可以这样做），但更困难的是，内核必须记录设备中断并将其分配到正确的用户模式环境。

x86处理器使用EFLAGS寄存器中的IOPL位来确定是否允许受保护模式代码执行特殊设备I/O指令，如输入和输出指令。由于我们需要访问的所有IDE磁盘寄存器都位于x86的I/O空间中，而不是内存映射，因此我们只需向文件系统环境授予“I/O权限”即可允许文件系统访问这些寄存器。实际上，EFLAGS寄存器中的IOPL位为内核提供了一种简单的“全有或全无”方法来控制用户模式代码是否可以访问I/O空间。在本例中，我们希望文件系统环境能够访问I/O空间，但我们不希望任何其他环境能够访问I/O空间。